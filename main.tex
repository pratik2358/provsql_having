\documentclass[10pt,a4paper]{scrartcl}
\usepackage[left=1cm, right=1cm]{geometry}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{mathrsfs}
\usepackage{csquotes}
\usepackage{listings}
\usepackage{minted}
\usepackage[bb=boondox]{mathalfa}
\usepackage{amsthm}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem*{remark}{Remark}
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\newtheorem{proposition}[theorem]{Proposition}
\theoremstyle{remark}
\DeclareMathAlphabet{\mathdutchcal}{U}{dutchcal}{m}{n}
\SetMathAlphabet{\mathdutchcal}{bold}{U}{dutchcal}{b}{n}
\DeclareMathAlphabet{\mathdutchbcal}{U}{dutchcal}{b}{n}
\newcommand{\dq}[1]{\text{\enquote{#1}}}
\newcommand{\op}{\hspace{0.1cm}\mathsf{op}\hspace{0.1cm}}
\makeatletter
\newcommand{\bigplus}{%
  \DOTSB\mathop{\mathpalette\mattos@bigplus\relax}\slimits@
}
\newcommand\mattos@bigplus[2]{%
  \vcenter{\hbox{%
    \sbox\z@{$#1\sum$}%
    \resizebox{!}{0.9\dimexpr\ht\z@+\dp\z@}{\raisebox{\depth}{$\m@th#1+$}}%
  }}%
  \vphantom{\sum}%
}
\newcommand{\mline}[1]{%
  \begin{multiline}
    #1
  \end{multiline}
}
\newcommand{\llbracket}{[\![}
\newcommand{\rrbracket}{]\!]}
\makeatother
\title{Provenance for Relational Queries with Nested Aggregation}
\author{Aryak Sen \and Pratik Karmakar \and Silviu Maniu \and Pierre Senellart}
\date{}

\begin{document}
\maketitle
\section{Introduction}
Nested aggregations are an important feature to
have in a practical system. Basic support of nested aggregation
is already implemented in ProvSQL. However, there is an
important semantics issue: the approach presented in the
literature for supporting nested aggregation, which adds a
comparison operator, makes sense for some specific provenance
frameworks (such as Boolean provenance), but there is no
clear semantics of how these comparison operators should
be implemented for arbitrary m-semirings.
\section{Setup}
Let's assume that any selection on the result of an aggregation is an 
atomic selection of the form .k=C or .k=.j. If not, we can write:

$\sigma_{\phi\land\psi}(q)=\sigma(\phi)(\sigma(\psi)(q))$
$\sigma_{\phi\lor\psi}(q)=\sigma(\phi)(q)\cup\sigma(\psi)(q)$
$\sigma_{\lnot\phi}(q)=q-\sigma(\phi)(q)$\\

$
\langle\sigma_{\#k\ op\ C}(q)\rangle^{\hat I}
=\{\{(u,\alpha\otimes[u.k\ op\ 1*C])\mid(u,\alpha)\in \langle q\rangle^{\hat I}, \alpha\otimes[u.k\ op\ C]\neq 0\}\}
$\\

$
\langle\sigma_{\#k\ op\ \#j}(q)\rangle^{\hat I}
=\{\{(u,\alpha\otimes[u.k\ op\ u.j])\mid(u,\alpha)\in \langle q\rangle^{\hat I}, \alpha\otimes[u.k\ op\ \#j]\neq 0\}\}
$\\
when .k refers to a column that dynamically has type “aggregate”.

% Semantics of [semimodule op semimodule] in different algebraic structures:
% - for formula, write it with concatenation
% - for Boolean function semiring, semantics of possible worlds
% - for why-semiring?
% - for which-semiring/lineage?
% - for counting-semiring?
% - for min-max/security semiring?
% - for tropical semiring?
% - etc.

What would be nice is that simple cases reduce to just evaluating joins.

$\langle\Pi_{\#1}(\sigma_{\#2>1}(\gamma_{\#1}[1:+](R)))\rangle^{\hat I}$
should be equal to something like
$\langle \epsilon(\Pi_{\#1}(\sigma_{\#2\neq\#4}(R\bowtie_{\#1=\#3} R))\rangle^{\hat I}$

R is assumed to be a binary relation without duplicates.


\section{Reducing HAVING COUNT$(*) > C$ to a JOIN-equivalent query}

$R \subseteq  A \times B$ is a binary relation without duplicates.
Counting semiring : $K = (\mathcal{N}, +, ., 0, 1)$

Define $n_g = |\{b \in B\ \mid (g,b) \in R\}|$ to be the no. of unique tuples corresponding to group $g$.

$Q_1$:$\langle\Pi_{\#1}(\sigma_{\#2>C}(\gamma_{\#1}[1:+](R)))\rangle^{\hat I}$

$Q_2$: $\langle \epsilon(\Pi_{\#1}(\sigma_{distinct}(\rho_{R_1}(R)\bowtie_{\#1=\#3} \rho_{R_2}(R)\bowtie_{\#1=\#5}\dots\bowtie_{\#1=\#(2C+1)}\rho_{R_{C+1}}(R))))\rangle^{\hat I}$

Evaluating provenance semantics for $Q_1$:

$\gamma_{\#1}[1:+](R)$ evaluates $COUNT(*)$ for each corresponding group. $\sigma_{\#2>C}$ gives us groups with more than $C$ tuples, projecting on the group key $\Pi_{\#1}$.
Hence we get :

$\{ (g,\#1) \mid n_g > C \}$

For each group $g$ after selection ,
$$Prov(g) = \begin{cases}
   1, & n_g > C \\
   0, & \text{otherwise}
   \end{cases}$$

Evaluating provenance semantics for $Q_2$:

So we have a $C+1$-way self-join.
We keep the tuples for which  all of $(g,r_1),(g,r_2),\dots,(g,r_{C+1})$ are pairwise distinct. We then project on $\#1$ and elimate duplicates using $\epsilon$.

This basically gives us:

$\{(g,\#1) \mid \exists r_1,\dots,r_{C+1} \text{  s.t. } (g,r_i) \in R, r_i\neq r_j \forall i \neq j  \}$

We defined R to be a binary relation without duplicates, hence $$\exists r_1,\dots,r_{C+1} \text{  s.t. } (g,r_i) \in R, r_i\neq r_j \forall i \neq j $$ is the same as $$n_g>C$$


For $C+1$ self-joins we consider tuples with only distinct $r_i$s.
No. of such tuples $n_{r, g}= n_g \cdot (n_g-1) \cdots (n_g - C)$
And each joined tuples contribute 1. 
We remove duplicates with $\epsilon$

$$Prov(g) = \begin{cases}
   1, & \text{if } n_{r, g} > 0 \leftrightarrow n_g > C \\
   0, & \text{otherwise}
   \end{cases}$$

\section{Semantics}
Extending on the algebra over annotated 
relations presented in \cite{sen2025provsqlgeneralkeepingtrack} by 
adding a new predicate form that allows 
comparison between aggregations we fill the semantics gap that 
was noted and left for future work.
\subsection{Possible world semantics over tuples}
\paragraph{Setup.}
Let $(K,\oplus,\otimes,\mathbb{0}_K,\mathbb{1}_K,\delta,\ominus)$ be an m-semiring of annotations with an 
added $\delta$ operation and, $(M,+_M,\mathbb{0}_M)$ be an 
additive monoid of aggregate values. Let $*:K\times M \mapsto K$ be a scalar action of $M$ on $K$, such that for $a \in K, b \in M$, 
$a * b = a \times b \in K$.
We fix a finite set $\mathbf{X}$ of variables. Each $\mathbf{x}\in\mathbf{X}$ have provenance annotations in $K$ and values in $M$ 
given by a semimodule ($K\times M$, say $\mathcal{M}$) map 
\[
\mathfrak{Z}:\mathbf{X}\rightarrow \mathcal{M}\; \text{and} \quad \mathfrak{Z}^{(K)}(\mathbf{x})=\mathbf{x}^{(K)}, \; \mathfrak{Z}^{(M)}(\mathbf{x})=\mathbf{x}^{(M)}
\]
An aggregation $\mathdutchcal{a}$ is defined by an indicator function 
$I_\mathdutchcal{a}:\mathbf{X}\rightarrow \{0,1\}$
on variables from $\mathbf{X}$ that participate in the aggregation as 
\[
\mathdutchcal{a} = {\bigoplus_\mathcal{M}}_{\mathbf{x}\in \mathrm{supp}(\mathdutchcal{a})}(\mathbf{x}^{(K)},\mathbf{x}^{(M)})
\]
where, 
$\mathrm{supp}(\mathdutchcal{a})=\{\,\mathbf{x} \mid I_\mathdutchcal{a}(\mathbf{x})=1 \,\}$ and 
$\bigoplus_{\mathcal{M}}$ is a formal $\mathcal{M}-$sum over 
variables $\mathbf{x}$ involved in the aggregation.
A possible world is a represented by a subset $W\subseteq\mathbf{X}$.
\paragraph{Possible-world semantics.}
For any two aggregations $\mathdutchcal{u},\mathdutchcal{v}$, we define the comparison operator $\oslash$ at the semimodule level as, 
\[
[\mathdutchcal{u} \oslash \mathdutchcal{v}]_{\mathit{op}\in\{ =, \neq , >, <, \geq, \leq\}}:\mathcal{M} \times \mathcal{M} \rightarrow K 
\]
such that,
\begin{multline}
[\mathdutchcal{u} \oslash \mathdutchcal{v}]_{\mathrm{op}}=
\bigoplus_{W} 
\Biggl(
  \Bigl( \bigotimes_{W\cap\mathrm{supp}(\mathdutchcal{u})} \mathbf{x}^{(K)} \Bigr) \;\otimes\; \Bigl( \bigotimes_{W\cap\mathrm{supp}(\mathdutchcal{v})} \mathbf{x}^{(K)} \Bigr)
\otimes
  \chi_{\mathrm{op}}\bigl(  {\bigplus_M}_{W\cap\mathrm{supp}(\mathdutchcal{u})} \mathbf{x}^{(M)}, {\bigplus_M}_{W\cap\mathrm{supp}(\mathdutchcal{v})} \mathbf{x}^{(M)}   \bigr)
\;\otimes\;\\
  \Biggl(\mathbb{1}_K \ominus \Biggl( \bigoplus_{(\mathbf{X}\setminus W)\cap\mathrm{supp}(\mathdutchcal{u})} \mathbf{x}^{(K)} \;\oplus\; \bigoplus_{(\mathbf{X}\setminus W)\cap\mathrm{supp}(\mathdutchcal{u})} \mathbf{x}^{(K)} \Biggr)\Biggr)
\Biggr)
\end{multline}
where,
$\chi_{\mathrm{op}}\bigl(  {\bigplus_M}_{W\cap\mathrm{supp}(\mathdutchcal{u})} \mathbf{x}^{(M)}, {\bigplus_M}_{W\cap\mathrm{supp}(\mathdutchcal{v})} \mathbf{x}^{(M)}   \bigr)=
\begin{cases}
\mathbb{1}_K & \text{if } {\bigplus_M}_{W\cap\mathrm{supp}(\mathdutchcal{u})} \mathbf{x}^{(M)}\;\mathit{op}\;{\bigplus_M}_{W\cap\mathrm{supp}(\mathdutchcal{v})} \mathbf{x}^{(M)},\\
\mathbb{0}_K & \text{otherwise.}
\end{cases}$ 
\paragraph{Complexity}

We show that provenance evaluation of a comparison between 
two aggregations over an additive monoid $M$, 
represented as formal $\mathcal{M}$-sums over an arbitrary 
absorptive $m-$semiring of annotations $K$, when defined by a
semimodule-level operator
$\oslash$ based on the proposed semantics is computationally hard.
While this \textsc{Aggregation-Comparison}(\textbf{AC}) produces 
a formal provenance over all possible worlds, we first define a 
suitable decision version to formalize its hardness. 
\begin{definition}[\textsc{Aggregation-Comparison-Decision} (\textbf{ACD})]
  Given two $\mathcal{M}-$aggregations $\mathdutchcal{u}$ and $\mathdutchcal{v}$ over a 
  finite set of variables $\mathbf{X}$
  the \textbf{ACD} problem asks whether there exists a possible world $W\subseteq\mathbf{X}$ such 
  that the provenance evaluation of the comparison in an additive monoid $M$ is non-zero in 
  the $m-$semiring $K$ :
\[
  [\mathdutchcal{u} \oslash \mathdutchcal{v}]_=^W\neq\mathbb{0}_{K}
  \]
\end{definition}
\begin{remark}
  $  [\mathdutchcal{u} \oslash \mathdutchcal{v}]_=^W$ follows our original semantics exactly but for a specific $W\subseteq\mathbf{X}$ without the outer disjunction over all possible worlds.
\end{remark}
The \textsc{Subset-Sum} problem is a classical NP-complete problem which we would use later in our proof. To avoid unnecessary complications we define a set-theoretic version of the \textsc{Subset-Sum} problem which is also NP-complete. 
\begin{definition}[\textsc{Subset-Sum}]
  Given a finite set $S\subset\mathbb{Z}_{\geq 0}$ and a target sum $P\in\mathbb{Z}_{\geq 0}$ does 
  there exist $S'\subseteq S$ such that $\sum_{s\in S'}s=P$ ?
\end{definition}
\begin{theorem}\label{th:ACD_NP}
  \textbf{ACD} is NP-complete.
\end{theorem}
\begin{proof}
W.l.o.g. we specialise \textbf{ACD} over $(\mathbb{Z}_{\geq 0},+,\cdot)$ and the free $m-$semiring of polynomials 
$\mathbb{N}[\mathbf{X}]$.
\paragraph{\textbf{ACD}$\in$NP.}
Let $W\subseteq\mathbf{X}$ be a candidate solution. We verify in polynomial time whether 
  $[\mathdutchcal{u} \oslash \mathdutchcal{v}]_=^W\neq0$.\\
${\bigplus_{\mathbb{Z}_{\geq 0}}}_{W\cap\mathrm{supp}(\mathdutchcal{u})} \mathbf{x}^{(\mathbb{Z}_{\geq 0})}\text{ and }{\bigplus_{\mathbb{Z}{\geq 0}}}_{W\cap\mathrm{supp}(\mathdutchcal{v})} \mathbf{x}^{(\mathbb{Z}{\geq 0})}$ can be computed in polynomial time.
Then, $\chi_=$ is just a boolean check over these computed sums. 
Further, we compute the provenance annotations in $\mathbb{N}[X]$ and all these steps 
are polynomial-time in the size of our constructed instance, so \textbf{ACD}$\in$NP.
\paragraph{ACD is NP-hard.}
We reduce an instance of \textsc{Subset-Sum} to an \textbf{ACD}-instance in polynomial time.\\
We construct $\mathbf{X}^*$ from $\mathbf{X}$ by ensuring that for each $s\in S$ we include a $\mathbf{x}\in\mathbf{X}$ for which 
  $\mathfrak{Z}^{(\mathbb{Z}_{\geq 0})}(\mathbf{x})=s$. We also inlude in $\mathbf{X}^*$ an $\mathbf{x}\in\mathbf{X}$ such that 
  $\mathfrak{Z}^{(\mathbb{Z}_{\geq 0})}(\mathbf{x})=P$. Hence, $|\mathbf{X}^*|=|S|+1$.\\
  We further define two aggregates $\mathdutchcal{u}$ and $\mathdutchcal{v}$ with $\mathrm{supp}(\mathdutchcal{u})=\{\mathbf{x}\in\mathbf{X}^*\mid\mathfrak{Z}^{(\mathbb{Z}_{\geq 0})}(\mathbf{x})=s\}$ and $\mathrm{supp}(\mathdutchcal{v})=\{\mathbf{x}\in\mathbf{X}^*\mid\mathfrak{Z}^{(\mathbb{Z}_{\geq 0})}(\mathbf{x})=P\}$, respectively.
  $[\mathdutchcal{u}\oslash\mathdutchcal{v}]_=$ is computed using semiring 
  operations in a free $\mathbb{N}[\mathbf{X}]$ over provenance 
  annotations decided by a valuation $\mathfrak{Z}^{(\mathbb{N}[\mathbf{X}])}$ 
  and any $W\subseteq\mathbf{X}^*$ will always result in syntactic 
  non-zero polynomial summands in  $[\mathdutchcal{u}\oslash\mathdutchcal{v}]_=$  
  unless $\chi_==0$. $[\mathdutchcal{u}\oslash\mathdutchcal{v}]_=$
evaluates to a nonzero element of $\mathbb{N}[\mathbf{X}]$
iff there exists a $S'\subseteq S$ whose elements sum to $P$.
  In other words, a \textbf{YES}-instance of \textsc{Subset-Sum} will only always reduce to an \textbf{ACD} \textbf{YES}-instance and a \textbf{NO}-instance 
  of \textsc{Subset-Sum} will only always reduce to a \textbf{NO}-instance of \textbf{ACD}. This reduction, clearly, is in polynomial time in $|S|+1$ and hence 
  \textbf{ACD} is NP-hard.
\paragraph{NP-completeness}
From NP membership and hardness, \textbf{ACD} is NP-complete.
\end{proof}

\begin{remark}[On generality]
Our reduction is carried out in $\mathbb{N}[\mathbf{X}]$. And by its universal property, for any arbitrary m-semiring $K$ 
  and valuation $\mathfrak{Z}^{(K)}$, $\exists$ a unique homomorphism $\mathcal{E}_{\mathfrak{Z}^{(K)}}:\mathbb{N}[\mathbf{X}]\rightarrow K$. Hardness can be transferred 
  to any arbitrary m-semiring $K$ for which one can choose a semiring valuation $\mathfrak{Z}^{(K)}$ that preserves non-zeroness of the provenance summands in the reduction.
\end{remark}
We now define a counting version of the \textsc{Subset-Sum} problem, which is a known \#P-complete problem.
\begin{definition}[\#\textsc{Subset-Sum}]
  Given a finite set $S\subset\mathbb{Z}_{\geq 0}$ and a target sum $P\in\mathbb{Z}_{\geq 0}$, count the number of subsets $S'\subseteq S$ such that $\sum_{s\in S'}s = P$.
\end{definition}
\begin{theorem}
  \#\textbf{AC} is $\#$\textbf{P}-hard.
\end{theorem}
\begin{proof}
  W.l.o.g, over $\mathbb{N}[\mathbf{X}]$ and $(\mathbb{Z}_{\geq 0},+,\cdot)$ \textbf{AC} enumerates all possible worlds where the aggregate comparison is satisfied. 
  We consider a counting version of \textbf{AC}, say \#\textbf{AC}, that simply counts the number of satisfying possible worlds.
  For each subset that is to be checked for equality in \#\textsc{Subset-Sum}, it is easy to reduce the candidate instances into an \#\textbf{AC} instance, 
  using the the same construction as defined in the proof of Theorem~\ref{th:ACD_NP}.\\
  And consequently, there exists a bijection between subsets $S'\subseteq S$ with $\sum_{s\in S'} s =P$ and possible worlds $W$ that yields a non-zero provenance summand in $\mathbb{N}[\textbf{X}]$ thus contributing to the \textit{count} in \#\textbf{AC}. 
  Therefore, the output of \#\textbf{AC} equals the number of solutions to the \#\textsc{Subset-Sum} problem. And since  \#\textsc{Subset-Sum} is \#P-complete, \#\text{AC} is \#P-hard. 
\end{proof}
\begin{corollary}
  \textbf{AC} is $\#$\textbf{P}-hard and in the worst case explicit size of $[\mathdutchcal{u}\oslash\mathdutchcal{v}]_=$ is exponential in input size.
\end{corollary}
\begin{proof}
  Since \#\textbf{AC} is just a counting version of \textbf{AC}, \textbf{AC} is at least as hard as \#\textbf{AC}. Therefore, \textbf{AC} is \#P-hard. \\
  For every world \(W\subseteq\mathbf{X}\) we have
  \(W\cap\mathrm{supp}(\mathdutchcal{u})=|W|\ge0\), and
  \(\chi_= = \mathbb{1}_K\) for every good \(W\); therefore each world contributes the monomial
  \(\prod_{\textbf{x}\in W} x^{(K)}\). The outer disjunction over possible worlds expands to \(\prod_\mathbf{X}(1+\mathbf{x})\), which
  contains exactly \(2^{|\mathbf{X}|}\) distinct monomials. The input size
  of the constructed instance is \(O(|\mathbf{X}|)\),
  hence any explicit sum-of-monomials representation of the provenance must be of size
  \(\Omega(2^{|\mathbf{X}|})\).

\end{proof}
\subsection{Possible-world semantics - a lazy approach}
\begin{proposition}[Block-world mapping and lifted block-level possible-world semantics]
Let
  $\mathcal{B} = \{B_1,\dots,B_m\}$ be a collection of blocks disjointly partioning $\mathbf{X}$ such that
\[
\bigcup_{k=1}^m B_k = \mathbf{X}
\qquad\text{and}\qquad
B_i\cap B_j=\varnothing\ \text{for }i\neq j,
\]
Let's abstractly denote $\mathbf{X}_b=\mathcal{B}$ as the universe of block-variables.

Define the mapping
\[
f:\mathcal{P}(\mathbf{X})\longrightarrow \mathcal{P}(\mathbf{X}_b),\qquad
f(W):=\{\,B\in\mathbf{X}_b \mid B\cap W\neq\varnothing\,\},
\]
which sends each tuple-level possible world $W\subseteq\mathbf{X}$ to the
set $W_b\subseteq\mathbf{X}_b$ of blocks that contain at least one tuple of
$W$.

Then:
\begin{enumerate}
  \item For every $W\subseteq\mathbf{X}$ the image $W_b=f(W)$ is \emph{unique}.
  \item The mapping $f$ induces a partition of the tuple-level worlds:
    for every $V\subseteq\mathbf{X}_b$,
    \[
      \mathcal{W}_V := \{\,W\subseteq\mathbf{X}\mid f(W)=V\,\}
    \]
    is the (possibly empty) fibre of $V$, and the family $\{\mathcal{W}_V\}_{V\subseteq\mathbf{X}_b}$
    is a partition of $\mathcal{P}(\mathbf{X})$.
  \item (Lifting of semantics) Let $(K,\oplus,\otimes,\mathbb{0}_K,\mathbb{1}_K,\delta,\ominus)$
    be the same $m$-semiring as in the tuple-level semantics, let $(M,+_M,\mathbb{0}_M)$ be the additive monoid of aggregate values,
    and let $\mathdutchcal{u},\mathdutchcal{v}$ be two aggregations defined over $\mathbf{X}$ as in the tuple-level setup. Define for each block
    $B\in\mathbf{X}_b$ the \emph{block-level} annotations and values by
    \[
      \mathbf{x}_B^{(K)} \;=\; \bigoplus_{\mathbf{x}\in B} \mathbf{x}^{(K)}
      \qquad\text{and}\qquad
      \mathbf{x}_B^{(M)} \;=\; \bigplus_{M,\;\mathbf{x}\in B} \mathbf{x}^{(M)},
    \]
    and let $\widehat{\mathdutchcal{u}},\widehat{\mathdutchcal{v}}$ be the induced aggregations on $\mathbf{X}_b$
    (i.e. they include exactly those blocks that contain some original variables in the supports of $\mathdutchcal{u},\mathdutchcal{v}$ respectively).
    Then the tuple-level possible-world comparison
    $[\mathdutchcal{u}\oslash\mathdutchcal{v}]_{\mathrm{op}}$ equals the block-level expression obtained by summing, for each block-world $V\subseteq\mathbf{X}_b$, the contributions of all tuple-worlds mapping to $V$:
    \[
      [\mathdutchcal{u}\oslash\mathdutchcal{v}]_{\mathrm{op}}
      \;=\;
      \bigoplus_{V\subseteq\mathbf{X}_b}
        \Biggl(
          \bigoplus_{W\in\mathcal{W}_V}
            \Bigl(
              \bigotimes_{W\cap\mathrm{supp}(\mathdutchcal{u})}\mathbf{x}^{(K)}
              \;\otimes\;
              \bigotimes_{W\cap\mathrm{supp}(\mathdutchcal{v})}\mathbf{x}^{(K)}
              \;\otimes\;
              \chi_{\mathrm{op}}\!\Bigl(\bigplus_{M,W\cap\mathrm{supp}(\mathdutchcal{u})}\mathbf{x}^{(M)},
                                      \bigplus_{M,W\cap\mathrm{supp}(\mathdutchcal{v})}\mathbf{x}^{(M)}\Bigr)
              \;\otimes\;
              \Phi_{W}
            \Bigr)
        \Biggr),
    \]
    where $\Phi_{W}$ denotes the ``outside-world mask'' factor appearing in the tuple-level semantics
    (the factor involving $\ominus$ in the original definition), and, equivalently, one may rewrite the inner sum
    in terms of block-level annotations as
    \[
      [\mathdutchcal{u}\oslash\mathdutchcal{v}]_{\mathrm{op}}
      \;=\;
      \bigoplus_{V\subseteq\mathbf{X}_b}
        \Biggl(
          \Bigl(\!\bigotimes_{B\in V\cap\mathrm{supp}(\widehat{\mathdutchcal{u}})} \mathbf{x}_B^{(K)}\Bigr)
          \otimes
          \Bigl(\!\bigotimes_{B\in V\cap\mathrm{supp}(\widehat{\mathdutchcal{v}})} \mathbf{x}_B^{(K)}\Bigr)
          \otimes
          \widehat{\chi}_{\mathrm{op}}\!\Bigl(\bigplus_{M,B\in V\cap\mathrm{supp}(\widehat{\mathdutchcal{u}})}\mathbf{x}_B^{(M)},
                                          \bigplus_{M,B\in V\cap\mathrm{supp}(\widehat{\mathdutchcal{v}})}\mathbf{x}_B^{(M)}\Bigr)
          \otimes
          \widehat{\Phi}_{V}
        \Biggr),
    \]
    where $\widehat{\chi}_{\mathrm{op}}$ and $\widehat{\Phi}_{V}$ are the natural block-level counterparts of $\chi_{\mathrm{op}}$ and $\Phi_{W}$.
\end{enumerate}
\end{proposition}

\begin{proof}
\begin{enumerate}
\item \textbf{Uniqueness of the image.}
The mapping $f$ is defined deterministically: given a tuple-world $W\subseteq\mathbf{X}$,
the set $f(W)=\{B\in\mathbf{X}_b\mid B\cap W\neq\varnothing\}$ is a well-defined subset of $\mathbf{X}_b$.
Because $f$ is a function (each input $W$ is assigned exactly one output $f(W)$), the image $W_b$ is unique.

\item \textbf{Fibres partition $\mathcal{P}(\mathbf{X})$.}
For any $V\subseteq\mathbf{X}_b$ the fibre $\mathcal{W}_V=\{W\subseteq\mathbf{X}\mid f(W)=V\}$ collects exactly those tuple-worlds whose tuples lie precisely in the blocks indexed by $V$ (i.e. each block in $V$ contains at least one tuple of $W$ and no tuple of $W$ lies in a block outside $V$). Distinct $V$ produce disjoint fibres, and every tuple-world $W$ lies in the fibre of $f(W)$, hence the family $\{\mathcal{W}_V\}_{V\subseteq\mathbf{X}_b}$ is a partition of $\mathcal{P}(\mathbf{X})$.

\item \textbf{Lifting of semantics.}
Start from the tuple-level possible-world expansion from your semantics:
\[
[\mathdutchcal{u}\oslash\mathdutchcal{v}]_{\mathrm{op}}
=
\bigoplus_{W\subseteq\mathbf{X}}
  \Gamma(W),
\qquad\text{where }\Gamma(W)
\coloneqq
  \Bigl(\bigotimes_{W\cap\mathrm{supp}(\mathdutchcal{u})}\mathbf{x}^{(K)}\Bigr)
  \otimes
  \Bigl(\bigotimes_{W\cap\mathrm{supp}(\mathdutchcal{v})}\mathbf{x}^{(K)}\Bigr)
  \otimes
  \chi_{\mathrm{op}}\!\Bigl(\bigplus_{M,W\cap\mathrm{supp}(\mathdutchcal{u})}\mathbf{x}^{(M)},
                          \bigplus_{M,W\cap\mathrm{supp}(\mathdutchcal{v})}\mathbf{x}^{(M)}\Bigr)
  \otimes
  \Phi_{W}.
\]
Partition the outer sum according to the fibres of $f$:
\[
\bigoplus_{W\subseteq\mathbf{X}} \Gamma(W)
=
\bigoplus_{V\subseteq\mathbf{X}_b}\ \bigoplus_{W\in\mathcal{W}_V} \Gamma(W).
\]
This is merely a reorganization of the sum using the partition $\{\mathcal{W}_V\}$ established above.

It remains to show that each inner sum $\bigoplus_{W\in\mathcal{W}_V}\Gamma(W)$ can be expressed in terms of block-level annotations
$\mathbf{x}_B^{(K)}$ and $\mathbf{x}_B^{(M)}$. By the definitions
\[
\mathbf{x}_B^{(K)}=\bigoplus_{\mathbf{x}\in B}\mathbf{x}^{(K)}
\qquad\text{and}\qquad
\mathbf{x}_B^{(M)}=\bigplus_{M,\;\mathbf{x}\in B}\mathbf{x}^{(M)},
\]
the product over all tuple-level annotations in $W\cap\mathrm{supp}(\mathdutchcal{u})$
can be regrouped block-wise. More precisely, because the blocks are disjoint,
for $W\in\mathcal{W}_V$ the set $W\cap\mathrm{supp}(\mathdutchcal{u})$ is equal to
\[
\bigcup_{B\in V}\bigl(B\cap\mathrm{supp}(\mathdutchcal{u})\bigr),
\]
and therefore
\[
\bigotimes_{W\cap\mathrm{supp}(\mathdutchcal{u})}\mathbf{x}^{(K)}
=
\bigotimes_{B\in V}
  \Bigl(\bigotimes_{\mathbf{x}\in B\cap\mathrm{supp}(\mathdutchcal{u})}\mathbf{x}^{(K)}\Bigr).
\]
Applying the semiring addition $\oplus$ inside each block (which is how we define $\mathbf{x}_B^{(K)}$)
and using distributivity in the $m$-semiring,
the inner combination over all tuple-worlds $W$ mapping to the same block-world $V$ collapses to an expression
involving only the block-level annotations and block-level aggregate values.
Analogous regrouping applies to the $M$-sums used inside $\chi_{\mathrm{op}}$.

Hence each inner sum $\bigoplus_{W\in\mathcal{W}_V}\Gamma(W)$ can be rewritten as a block-level term of the form
\[
\Bigl(\!\bigotimes_{B\in V\cap\mathrm{supp}(\widehat{\mathdutchcal{u}})} \mathbf{x}_B^{(K)}\Bigr)
\otimes
\Bigl(\!\bigotimes_{B\in V\cap\mathrm{supp}(\widehat{\mathdutchcal{v}})} \mathbf{x}_B^{(K)}\Bigr)
\otimes
\widehat{\chi}_{\mathrm{op}}\!\Bigl(\bigplus_{M,B\in V\cap\mathrm{supp}(\widehat{\mathdutchcal{u}})}\mathbf{x}_B^{(M)},
                                \bigplus_{M,B\in V\cap\mathrm{supp}(\widehat{\mathdutchcal{v}})}\mathbf{x}_B^{(M)}\Bigr)
\otimes
\widehat{\Phi}_{V},
\]
where $\widehat{\chi}_{\mathrm{op}}$ tests the block-level aggregated quantities and $\widehat{\Phi}_{V}$
is the block-level counterpart of the outside-world mask. Substituting these block-level terms back into the outer sum yields the claimed block-level expression.

This completes the proof.

\end{enumerate}
\end{proof}

\begin{remark}

\begin{itemize}
  \item The partition (disjointness) hypothesis on the blocks is crucial for the simple form of the map $f$ and the algebraic regrouping. If blocks overlap (e.g. in certain storage/replication layouts) the mapping still exists but the algebraic lifting requires careful duplication-accounting.
  \item The equalities above are algebraic reorganisations inside the $m$-semiring and the monoid $(M,+_M)$. From an implementation viewpoint this is precisely why block-level possible-worlds can be used as a compact surrogate for tuple-level worlds, and why lazy expansion (reconstructing tuple-level annotations inside a block on demand) is sound: the block-level expression subsumes (by the fibres) the contributions of all tuple-level worlds lying under a given block-world.
\end{itemize}
\end{remark}

\section{Semiring of Boolean Functions}

\(\varphi\colon \{\bot,\top\}^X \to \{\bot,\top\}\) is a Boolean-function annotation on tuples.
A valuation \(\nu\colon X \to \{\bot,\top\}\) denotes a possible world,
  indicating which tokens \(x\in X\) exist (\(\nu(x)=\top\)).
The semiring of Boolean functions is:
$$
B^X = (\{\varphi : \{ \bot,\top \}^X \to \{\bot,\top\}\},\vee,\wedge,0_B,1_B,\setminus_B)
$$
\begin{itemize}
    \item \(\varphi \vee \psi\): pointwise OR
    \item \(\varphi \wedge \psi\): pointwise AND
    \item \(0_B\): the constant-false function
    \item \(1_B\): the constant-true function
    \item Monus:
        $$
        \varphi \setminus_B \psi \;=\; \varphi \wedge \neg \psi
        $$
\end{itemize}

\section{counting semiring}
$$k = (\mathbb{n}, \oplus, \otimes, 0, 1)$$
$\mathbb{n} = \{0,1,2,\dots\}$

$\oplus : \text{standard integer addition}$

$\otimes : \text{standard integer multiplication}$

$\text{zero} : 0 \in \mathbb{n}$

$\text{one} : 1 \in \mathbb{n}$

additional operators:

monus: $(a \ominus b): \text{truncated subtraction}$
$$ a \ominus b = \begin{cases} 0, &  a\leq b\\ a-b,& a>b \end{cases}$$

delta: 
for $a \in k$
$\delta(a) = \begin{cases} 0, & a=0\\ 1, & a>0 \end{cases}$
$\delta:k \mapsto k $
$\delta(0_k)=0_k$
$\delta(n.1_k)=1_k$


\textbf{counting semiring properties:}

1. additive monoid
- associativity: $$(a \oplus b) \oplus c = a \oplus (b\oplus c)$$
- commutativity: $$a \oplus b = b \oplus a$$
- identity: $$a \oplus 0 = 0$$
2. Multiplicative monoid
- Associativity: $$( (a \otimes b) \otimes c = a \otimes (b\otimes c)$$
- Commutativity: $$a \otimes b = b \otimes a$$
- Identity: $$a \otimes 1 = a$$
3. Distributivity
- Left Dist: $$a \otimes (b \oplus c)= (a \otimes b)\oplus(a \otimes c)$$
- RIght Dist: $$(a \oplus b)\otimes c=(a \otimes c)\oplus(b \otimes c)$$
 4. Absorption
$$a \otimes 0 = 0 \otimes a = 0$$

5. Monus \newline
For $$a, b \in K$$
- $$(a \ominus b) \oplus b =a$$, if $$a \geq b$$
- $$a \ominus 0 =a$$
- $$0 \ominus a = 0$$

6. Semimodule operation
- Associative with semiring multiplication: $$a \otimes (b * m)= (a \otimes b) * m$$
- Identity: $$1*m=m$$
- Absorption: $$0*m=0$$
7. Other properties
$$
 \delta(u)\otimes[[u \oslash   v]]_{\mathit{op}}=\begin{cases}1, & \text{if } u\hspace{0.5em} op\hspace{0.5em} v \text{ holds in } \mathbb{N} \\
0,&\text{o.w.}\end{cases}
$$

e.g. For COUNT(*), say we have $f=\bigoplus_{g \in group}$ 1 and we want to filter on the aggregates HAVING >C

$$
 \delta(f)\otimes[[f \oslash   C]]_{\mathit{>}}=\begin{cases}1, & \text{if } f>C \text{ holds in } \mathbb{N} \\
0,&\text{o.w.}\end{cases}
$$

\section{Boolean Semiring}
$$B = (\{0,1\}, \lor, \land, 0, 1)$$
$$\lor : \text{Standard logical OR}$$
$$\land : \text{Standard logical AND}$$
$$0 : \text{Boolean zero}$$
$$1 : \text{Boolean one}$$
\[
\ominus: \text{Monus for Boolean Semiring} \quad a \ominus b := a \land \neg b
\]
Now we take a query as below on a relation $T$ with $n$ tuples:

\begin{listing}[ht]
\begin{minted}[linenos,frame=single,fontsize=\small]{sql}
SELECT DISTINCT 1
  FROM T
 HAVING COUNT(*) = c;
\end{minted}
\end{listing}

This returns 1 if the relation $T$ has exactly $c$ tuples, and 0 otherwise.

In possible world semantics, let $w: \{1,2,\dots,m\} \mapsto \{0,1\}$.

The provenance of this query can be expressed as follows:

$$q(T) = \bigoplus_{w}\left(\bigotimes_{w(i)=1}b_i\otimes\left(\mathbb{1}\ominus(\bigoplus_{w(i) =0}b_i)\right)\right)$$

On the other hand, its equivalent join query will be as follows:

\begin{listing}[ht]
\caption{Return 1 if \(|T| = c\) using joins on distinct rows}
\begin{minted}[linenos,frame=single,fontsize=\small]{sql}
SELECT DISTINCT 1
  FROM T AS a1
  JOIN T AS a2 ON a1.id <  a2.id
  JOIN T AS a3 ON a2.id <  a3.id
  -- ...
  JOIN T AS a_c ON a_{c-1}.id < a_c.id

EXCEPT

SELECT DISTINCT 1
  FROM T AS b1
  JOIN T AS b2 ON b1.id <  b2.id
  JOIN T AS b3 ON b2.id <  b3.id
  -- ...
  JOIN T AS b_{c+1} ON b_c.id < b_{c+1}.id;
\end{minted}
\end{listing}

The provenance of this query can be expressed as follows:
\[
q'(T) = \bigoplus_{\substack{t\subseteq T \\ |t| = c}}\left(\bigotimes_{\substack{b_i\in t}}b_i\right) \ominus \bigoplus_{\substack{t'\subseteq T \\ |t'| = c+1}}\left(\bigotimes_{\substack{b_i\in t'}}b_i\right)
\]

\begin{proof}
Define
\[
A \;=\; \bigvee_{\lvert t\rvert = c}\;\bigwedge_{i\in t} b_i,
\qquad
B \;=\; \bigvee_{\lvert t'\rvert = c+1}\;\bigwedge_{i\in t'} b_i.
\]
Since in the Boolean semiring \(\oplus=\vee\), \(\otimes=\wedge\) and
\(\;r\ominus s = r\wedge\neg s\), we have
\[
q'(T)
= A \ominus B
= A \wedge \neg B.
\]
Expand step by step:
\begin{align*}
q'(T)
&= \Bigl(\!\bigvee_{\lvert t\rvert = c}\!\bigwedge_{i\in t}b_i\Bigr)
   \;\wedge\;
   \neg\Bigl(\!\bigvee_{\lvert t'\rvert = c+1}\!\bigwedge_{i\in t'}b_i\Bigr)\\[6pt]
&= \Bigl(\!\bigvee_{\lvert t\rvert = c}\!\bigwedge_{i\in t}b_i\Bigr)
   \;\wedge\;
   \Bigl(\!\bigwedge_{\lvert t'\rvert = c+1}\!\neg\bigl(\!\bigwedge_{i\in t'}b_i\bigr)\Bigr)\\[6pt]
&= \bigvee_{\lvert t\rvert = c}
    \Bigl(
      \bigwedge_{i\in t}b_i
      \;\wedge\;
      \bigwedge_{|t'|=c+1}\!\neg\bigl(\!\bigwedge_{i\in t'}b_i\bigr)
    \Bigr).
\end{align*}

\textbf{Key simplification.}  Fix a particular \(t\) with \(\lvert t\rvert=c\).  Consider
\[
\bigwedge_{\substack{t'\subseteq[m]\\|t'|=c+1}}
\neg\Bigl(\!\bigwedge_{i\in t'}b_i\Bigr).
\]
- For each \(j\notin t\), the subset \(t'=t\cup\{j\}\) yields
  \(\neg\bigl(b_j\wedge\bigwedge_{i\in t}b_i\bigr)=\neg b_j\).  
- Any other \(t'\) also contains some \(j\notin t\), so its factor
  \(\neg(\bigwedge_{i\in t'}b_i)\) can be written as
  \(\neg b_j\vee Y\).  

with \(x=\neg b_j\), each such pair of factors collapses to \(\neg b_j\).  Hence the entire
AND reduces to
\(\bigwedge_{j\notin t}\neg b_j\).

Substituting back gives
\[
q'(T)
=\bigvee_{\lvert t\rvert = c}
\Bigl(\,\bigwedge_{i\in t}b_i
       \;\wedge\;
       \bigwedge_{j\notin t}\neg b_j
\Bigr)
=\;q(T),
\]
as required.
\end{proof}
\section{Semiring of Boolean Functions}

\(\varphi\colon \{\bot,\top\}^X \to \{\bot,\top\}\) is a Boolean-function annotation on tuples.
A valuation \(\nu\colon X \to \{\bot,\top\}\) denotes a possible world,
  indicating which tokens \(x\in X\) exist (\(\nu(x)=\top\)).
The semiring of Boolean functions is:
$$
B^X = (\{\varphi : \{ \bot,\top \}^X \to \{\bot,\top\}\},\vee,\wedge,0_B,1_B,\setminus_B)
$$
\begin{itemize}
    \item \(\varphi \vee \psi\): pointwise OR
    \item \(\varphi \wedge \psi\): pointwise AND
    \item \(0_B\): the constant-false function
    \item \(1_B\): the constant-true function
    \item Monus:
        $$
        \varphi \setminus_B \psi \;=\; \varphi \wedge \neg \psi
        $$
\end{itemize}

\input{homomorphisms.tex}

% Example citation to ensure at least one \cite command is present
As shown in~\cite{amsterdamer2011provenance}, provenance semirings...

\bibliographystyle{splncs04}
\bibliography{ref}
\end{document}
