\documentclass{article}
\usepackage{graphicx} % Required for inserting images
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{mathrsfs}
\usepackage{csquotes}
\usepackage[bb=boondox]{mathalfa}
\newcommand{\dq}[1]{\text{\enquote{#1}}}
\newcommand{\op}{\hspace{0.1cm}\mathsf{op}\hspace{0.1cm}}
\makeatletter
\newcommand{\bigplus}{%
  \DOTSB\mathop{\mathpalette\mattos@bigplus\relax}\slimits@
}
\newcommand\mattos@bigplus[2]{%
  \vcenter{\hbox{%
    \sbox\z@{$#1\sum$}%
    \resizebox{!}{0.9\dimexpr\ht\z@+\dp\z@}{\raisebox{\depth}{$\m@th#1+$}}%
  }}%
  \vphantom{\sum}%
}
\makeatother
\title{Provenance of aggregate queries with HAVING clause in ProvSQL.}
\author{Pratik Karmakar \and Aryak Sen \and Silviu Maniu \and Pierre Senellart}
\date{}

\begin{document}
\maketitle
\section{Notes on aggregation and HAVING semantics}

Let's assume that any selection on the result of an aggregation is an 
atomic selection of the form .k=C or .k=.j. If not, we can write:

$\sigma_{\phi\land\psi}(q)=\sigma(\phi)(\sigma(\psi)(q))$
$\sigma_{\phi\lor\psi}(q)=\sigma(\phi)(q)\cup\sigma(\psi)(q)$
$\sigma_{\lnot\phi}(q)=q-\sigma(\phi)(q)$


$$
\langle\sigma_{\#k\ op\ C}(q)\rangle^{\hat I}
=\{\{(u,\alpha\otimes[u.k\ op\ 1*C])\mid(u,\alpha)\in \langle q\rangle^{\hat I}, \alpha\otimes[u.k\ op\ C]\neq 0\}\}
$$

$$
\langle\sigma_{\#k\ op\ \#j}(q)\rangle^{\hat I}
=\{\{(u,\alpha\otimes[u.k\ op\ u.j])\mid(u,\alpha)\in \langle q\rangle^{\hat I}, \alpha\otimes[u.k\ op\ \#j]\neq 0\}\}
$$
when .k refers to a column that dynamically has type “aggregate”.

Semantics of [semimodule op semimodule] in different algebraic structures:
- for formula, write it with concatenation
- for Boolean function semiring, semantics of possible worlds
- for why-semiring?
- for which-semiring/lineage?
- for counting-semiring?
- for min-max/security semiring?
- for tropical semiring?
- etc.

What would be nice is that simple cases reduce to just evaluating joins.

$\langle\Pi_{\#1}(\sigma_{\#2>1}(\gamma_{\#1}[1:+](R)))\rangle^{\hat I}$
should be equal to something like
$\langle \epsilon(\Pi_{\#1}(\sigma_{\#2\neq\#4}(R\bowtie_{\#1=\#3} R))\rangle^{\hat I}$

R is assumed to be a binary relation without duplicates.


\subsection{a first proof for HAVING COUNT$(*) > C$}

$R \subseteq  A \times B$ is a binary relation without duplicates.
Counting semiring : $K = (\mathcal{N}, +, ., 0, 1)$

Define $n_g = |\{b \in B\ \mid (g,b) \in R\}|$ to be the no. of unique tuples corresponding to group $g$.

$Q_1$:$\langle\Pi_{\#1}(\sigma_{\#2>C}(\gamma_{\#1}[1:+](R)))\rangle^{\hat I}$

$Q_2$: $\langle \epsilon(\Pi_{\#1}(\sigma_{distinct}(\rho_{R_1}(R)\bowtie_{\#1=\#3} \rho_{R_2}(R)\bowtie_{\#1=\#5}\dots\bowtie_{\#1=\#(2C+1)}\rho_{R_{C+1}}(R))))\rangle^{\hat I}$

Evaluating provenance semantics for $Q_1$:
$\gamma_{\#1}[1:+](R)$ evaluates $COUNT(*)$ for each corresponding group. $\sigma_{\#2>C}$ gives us groups with more than $C$ tuples, projecting on the group key $\Pi_{\#1}$.
Hence we get :

$\{ (g,\#1) \mid n_g > C \}$

For each group $g$ after selection ,
$$Prov(g) = \begin{cases}
   1, & n_g > C \\
   0, & \text{otherwise}
   \end{cases}$$

\subsection{Evaluating provenance semantics for $Q_2$:}

So we have a $C+1$-way self-join.
We keep the tuples for which  all of $(g,r_1),(g,r_2),\dots,(g,r_{C+1})$ are pairwise distinct. We then project on $\#1$ and elimate duplicates using $\epsilon$.

This basically gives us:

$\{(g,\#1) \mid \exists r_1,\dots,r_{C+1} \text{  s.t. } (g,r_i) \in R, r_i\neq r_j \forall i \neq j  \}$

We defined R to be a binary relation without duplicates, hence $$\exists r_1,\dots,r_{C+1} \text{  s.t. } (g,r_i) \in R, r_i\neq r_j \forall i \neq j $$ is the same as $$n_g>C$$


For $C+1$ self-joins we consider tuples with only distinct $r_i$s.
No. of such tuples $n_{r, g}= n_g \cdot (n_g-1) \cdots (n_g - C)$
And each joined tuples contribute 1. 
We remove duplicates with $\epsilon$

$$Prov(g) = \begin{cases}
   1, & \text{if } n_{r, g} > 0 \leftrightarrow n_g > C \\
   0, & \text{otherwise}
   \end{cases}$$




Should be same in join for absoptive semerings

\subsection{Counting Semiring Definitions:}
$$K = (\mathbb{N}, \oplus, \otimes, 0, 1)$$
$\mathbb{N} = \{0,1,2,\dots\}$

$\oplus : \text{Standard integer addition}$

$\otimes : \text{Standard integer multiplication}$

$\text{Zero} : 0 \in \mathbb{N}$

$\text{One} : 1 \in \mathbb{N}$

Additional operators:

Monus: $(a \ominus b): \text{Truncated subtraction}$
$$ a \ominus b = \begin{cases} 0, &  a\leq b\\ a-b,& a>b \end{cases}$$

Extra-semiring operations:
Semimodule operation$(*)$:

Let $K$ be a semiring and, $M$ be an additive monoid, with scalar $*:K\times M \mapsto M$, then for $a \in K, b \in M$
$$a * b = a \times b$$


Delta: 
For $a \in K$
$$\delta(a) = \begin{cases} 0, & a=0\\ 1, & a>0 \end{cases}$$
$$\delta:K \mapsto K $$
$$\delta(0_K)=0_K$$
$$\delta(n.1_K)=1_K$$

Aggregate comparison operation : \newline
Let $\mathcal{M}$ be a semimodule $K\times M$.
$[[\cdot]]_{\mathit{op}\in\{ =, \neq , >, <, \geq, \leq\}}: \mathcal{M} \times \{ =, \neq , >, <, \geq, \leq\} \times \mathcal{M} \rightarrow K$
For $u,v\in \mathcal{M}, op \in \{ =, \neq , >, <, \geq, \leq\}$  





Let $\mathcal{T} = \{t_1, t_2, \dots, t_n\}$, be the set of all tuples in the relational database and $w: \mathcal{T} \mapsto \{0,1\}$ be a possible world function and,
$\mathcal{W} = \{w \mid w:\mathcal{T} \mapsto \{0,1\}\}$, be the set of all possible worlds.
Then,

$$ [[u \oslash v]]_{op}= \bigoplus_{w \in \mathcal{W},{eval_w(u) \oslash eval_w(v)}} mon(w)\otimes\left(1 \ominus pol(w)\right)$$
where,
$eval_w(u)$ is the semimodule expression evaluated in world $w$ :

$$eval_{w}(u) = \sum_{t_i\in Vars(u)} w(t_i)\times annotation(t_i)*value(t_i)$$
$Vars(u) =$ set of all tuples in $u$.
and,
$$ mon(w)=\bigotimes_{w(t_i)=1}annotation(t_i)$$
$$pol(w)=\bigoplus_{w(t_i)=0}annotation(t_i)$$



Another way of setting up possible world definition:\newline
let $$w: \{1,2,\dots,m\} \mapsto \{0,1\}$$ and $$w': \{1,2,\dots,n\} \mapsto \{0,1\}$$
$\bigoplus_{w,w'}\left(\bigotimes_{w(i)=1}b_i\otimes\bigotimes_{w'(j) = 1}b'_j\otimes\left(1\ominus(\bigoplus_{w(i) =0}b_i\oplus \bigoplus_{w'(j) = 0}b'j)\right)\right)$

\subsubsection{Counting semiring properties}
1. Additive monoid
- Associativity: $$(a \oplus b) \oplus c = a \oplus (b\oplus c)$$
- Commutativity: $$a \oplus b = b \oplus a$$
- Identity: $$a \oplus 0 = 0$$
2. Multiplicative monoid
- Associativity: $$( (a \otimes b) \otimes c = a \otimes (b\otimes c)$$
- Commutativity: $$a \otimes b = b \otimes a$$
- Identity: $$a \otimes 1 = a$$
3. Distributivity
- Left Dist: $$a \otimes (b \oplus c)= (a \otimes b)\oplus(a \otimes c)$$
- RIght Dist: $$(a \oplus b)\otimes c=(a \otimes c)\oplus(b \otimes c)$$
 4. Absorption
$$a \otimes 0 = 0 \otimes a = 0$$

5. Monus \newline
For $$a, b \in K$$
- $$(a \ominus b) \oplus b =a$$, if $$a \geq b$$
- $$a \ominus 0 =a$$
- $$0 \ominus a = 0$$

6. Semimodule operation
- Associative with semiring multiplication: $$a \otimes (b * m)= (a \otimes b) * m$$
- Identity: $$1*m=m$$
- Absorption: $$0*m=0$$
7. Other properties
$$
 \delta(u)\otimes[[u \oslash   v]]_{\mathit{op}}=\begin{cases}1, & \text{if } u\hspace{0.5em} op\hspace{0.5em} v \text{ holds in } \mathbb{N} \\
0,&\text{o.w.}\end{cases}
$$

e.g. For COUNT(*), say we have $f=\bigoplus_{g \in group}$ 1 and we want to filter on the aggregates HAVING >C

$$
 \delta(f)\otimes[[f \oslash   C]]_{\mathit{>}}=\begin{cases}1, & \text{if } f>C \text{ holds in } \mathbb{N} \\
0,&\text{o.w.}\end{cases}
$$





\bibliographystyle{splncs04}
\bibliography{ref}
\end{document}
