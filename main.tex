\documentclass[twocolumn]{article}
\usepackage{graphicx} % Required for inserting images
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{mathrsfs}
\usepackage{csquotes}
\usepackage{listings}
\usepackage{minted}
\usepackage[bb=boondox]{mathalfa}
\usepackage{amsthm}

\newcommand{\dq}[1]{\text{\enquote{#1}}}
\newcommand{\op}{\hspace{0.1cm}\mathsf{op}\hspace{0.1cm}}
\makeatletter
\newcommand{\bigplus}{%
  \DOTSB\mathop{\mathpalette\mattos@bigplus\relax}\slimits@
}
\newcommand\mattos@bigplus[2]{%
  \vcenter{\hbox{%
    \sbox\z@{$#1\sum$}%
    \resizebox{!}{0.9\dimexpr\ht\z@+\dp\z@}{\raisebox{\depth}{$\m@th#1+$}}%
  }}%
  \vphantom{\sum}%
}
\newcommand{\mline}[1]{%
  \begin{multiline}
    #1
  \end{multiline}
}
\makeatother
\title{Provenance Semantics for Nested Aggregation}
\author{Pratik Karmakar \and Aryak Sen \and Silviu Maniu \and Pierre Senellart}
\date{}

\begin{document}
\maketitle
\section{Introduction}
Nested aggregations are an important feature to
have in a practical system. Basic support of nested aggregation
is already implemented in ProvSQL. However, there is an
important semantics issue: the approach presented in the
literature for supporting nested aggregation, which adds a
comparison operator, makes sense for some specific provenance
frameworks (such as Boolean provenance), but there is no
clear semantics of how these comparison operators should
be implemented for arbitrary m-semirings.

\section{Setup}
Let's assume that any selection on the result of an aggregation is an 
atomic selection of the form .k=C or .k=.j. If not, we can write:

$\sigma_{\phi\land\psi}(q)=\sigma(\phi)(\sigma(\psi)(q))$
$\sigma_{\phi\lor\psi}(q)=\sigma(\phi)(q)\cup\sigma(\psi)(q)$
$\sigma_{\lnot\phi}(q)=q-\sigma(\phi)(q)$\\

$
\langle\sigma_{\#k\ op\ C}(q)\rangle^{\hat I}
=\{\{(u,\alpha\otimes[u.k\ op\ 1*C])\mid(u,\alpha)\in \langle q\rangle^{\hat I}, \alpha\otimes[u.k\ op\ C]\neq 0\}\}
$\\

$
\langle\sigma_{\#k\ op\ \#j}(q)\rangle^{\hat I}
=\{\{(u,\alpha\otimes[u.k\ op\ u.j])\mid(u,\alpha)\in \langle q\rangle^{\hat I}, \alpha\otimes[u.k\ op\ \#j]\neq 0\}\}
$\\
when .k refers to a column that dynamically has type “aggregate”.

Semantics of [semimodule op semimodule] in different algebraic structures:
- for formula, write it with concatenation
- for Boolean function semiring, semantics of possible worlds
- for why-semiring?
- for which-semiring/lineage?
- for counting-semiring?
- for min-max/security semiring?
- for tropical semiring?
- etc.

What would be nice is that simple cases reduce to just evaluating joins.

$\langle\Pi_{\#1}(\sigma_{\#2>1}(\gamma_{\#1}[1:+](R)))\rangle^{\hat I}$
should be equal to something like
$\langle \epsilon(\Pi_{\#1}(\sigma_{\#2\neq\#4}(R\bowtie_{\#1=\#3} R))\rangle^{\hat I}$

R is assumed to be a binary relation without duplicates.


\subsection{Reducing HAVING COUNT$(*) > C$ to a JOIN-equivalent query}

$R \subseteq  A \times B$ is a binary relation without duplicates.
Counting semiring : $K = (\mathcal{N}, +, ., 0, 1)$

Define $n_g = |\{b \in B\ \mid (g,b) \in R\}|$ to be the no. of unique tuples corresponding to group $g$.

$Q_1$:$\langle\Pi_{\#1}(\sigma_{\#2>C}(\gamma_{\#1}[1:+](R)))\rangle^{\hat I}$

$Q_2$: $\langle \epsilon(\Pi_{\#1}(\sigma_{distinct}(\rho_{R_1}(R)\bowtie_{\#1=\#3} \rho_{R_2}(R)\bowtie_{\#1=\#5}\dots\bowtie_{\#1=\#(2C+1)}\rho_{R_{C+1}}(R))))\rangle^{\hat I}$

Evaluating provenance semantics for $Q_1$:

$\gamma_{\#1}[1:+](R)$ evaluates $COUNT(*)$ for each corresponding group. $\sigma_{\#2>C}$ gives us groups with more than $C$ tuples, projecting on the group key $\Pi_{\#1}$.
Hence we get :

$\{ (g,\#1) \mid n_g > C \}$

For each group $g$ after selection ,
$$Prov(g) = \begin{cases}
   1, & n_g > C \\
   0, & \text{otherwise}
   \end{cases}$$

Evaluating provenance semantics for $Q_2$:

So we have a $C+1$-way self-join.
We keep the tuples for which  all of $(g,r_1),(g,r_2),\dots,(g,r_{C+1})$ are pairwise distinct. We then project on $\#1$ and elimate duplicates using $\epsilon$.

This basically gives us:

$\{(g,\#1) \mid \exists r_1,\dots,r_{C+1} \text{  s.t. } (g,r_i) \in R, r_i\neq r_j \forall i \neq j  \}$

We defined R to be a binary relation without duplicates, hence $$\exists r_1,\dots,r_{C+1} \text{  s.t. } (g,r_i) \in R, r_i\neq r_j \forall i \neq j $$ is the same as $$n_g>C$$


For $C+1$ self-joins we consider tuples with only distinct $r_i$s.
No. of such tuples $n_{r, g}= n_g \cdot (n_g-1) \cdots (n_g - C)$
And each joined tuples contribute 1. 
We remove duplicates with $\epsilon$

$$Prov(g) = \begin{cases}
   1, & \text{if } n_{r, g} > 0 \leftrightarrow n_g > C \\
   0, & \text{otherwise}
   \end{cases}$$

Should be same in join for absoptive semerings

\subsection{Testing the provenance semantics on different m-semirings:}
Now we are going propose and validate our semantics across some m-semirings. The goal is to 
verify whether the semantics can be implemented within the algrebraic structures of each m-semiring 
while satisfying the required m-semiring axioms.

Let $(K,\oplus,\otimes,\mathbb{0},\mathbb{1},\delta,\ominus)$ be an m-semiring with an 
added $\delta$ operation and, $(M,+_M,\mathbb{0}_M)$ be an 
additive monoid of aggregate values. Let $*:K\times M \mapsto K$ be a scalar action of $M$ on $K$, such that for $a \in K, b \in M$, 
$a * b = a \times b \in K$.

We represent an aggregation expression $\mathbf{a}$ as  $\bigoplus_{\mathcal{M},i}(a_i^{(K)},a_i^{(M)})$ where $\bigoplus_{\mathcal{M}}$ is a formal semimodule($\mathcal{M}$) sum over 
variables $i$ involved in the aggregation.
Now for any two aggregations $\mathbf{u},\mathbf{v}$, we define the comparison operator $\oslash$ at the semimodule level as, 

$[\mathbf{u} \oslash \mathbf{v}]_{\mathit{op}\in\{ =, \neq , >, <, \geq, \leq\}}:\mathcal{M} \times \mathcal{M} \rightarrow K\}$ such that, 

\begin{multline}
[\mathbf{u} \oslash \mathbf{v}]_{\mathrm{op}}=
\bigoplus_{S,T} 
\Biggl(
\underbrace{
\Bigl( \bigotimes_{i \in S} u_i^{(K)} \Bigr) \;\otimes\; \Bigl( \bigotimes_{j \in T} v_j^{(K)} \Bigr)
}_{\text{product of annotations in } K} \\
\otimes
\underbrace{
\chi_{\mathrm{op}}\bigl(\mathrm{val}_\mathbf{u}(S), \mathrm{val}_\mathbf{v}(T)\bigr)
}_{\text{comparison result in K}} 
\;\otimes\;\\
\underbrace{
\Biggl(\mathbb{1}_K \ominus \delta\Biggl( \bigoplus_{i \notin S} u_i^{(K)} \;\oplus\; \bigoplus_{j \notin T} v_j^{(K)} \Biggr)\Biggr)
}_{\text{sum in $K$ of excluded variables}}
\Biggr)
\end{multline}

where,

$\chi_{\mathrm{op}}\bigl(\mathrm{val}_\mathbf{u}(S), \mathrm{val}_\mathbf{v}(T)\bigr)=\begin{cases}
\mathbb{1}_K & \text{if } \mathrm{val}_\mathbf{u}(S) \;\mathit{op}\; \mathrm{val}_\mathbf{v}(T),\\
\mathbb{0}_K & \text{otherwise.}
\end{cases}$ 

and, 
$\mathrm{val}_\mathbf{u}(S)$ and $\mathrm{val}_\mathbf{v}(T)$ are $\bigplus_{M, i \in S}u_i^{(M)}$  and 
$\bigplus_{M, j \in T}v_j^{(M)}$, $S$ and $T$ being possible world valuations.

\textbf{Toy example (in formula semiring):}
Consider the aggregation expressions:

\[
\mathbf{u} = \{ (t_1,5), (t_2,7) \}, \quad
\mathbf{v} = \{ (t_3,6) \}
\]

where each element is a semimodule element $(u_i^{(K)}, u_i^{(M)})$:

\begin{itemize}
    \item $u_i^{(K)}$ is the provenance annotation in the semiring $K$ (here, strings $t_1, t_2, t_3$)
    \item $u_i^{(M)}$ is the numeric monoid value
\end{itemize}
\[
S \subseteq \mathbf{u}: \{ \{t_1\}, \{t_2\}, \{t_1,t_2\} \}, \quad
T \subseteq \mathbf{v}: \{ \{t_3\} \}
\]

\begin{align*}
[\mathbf{u} \oslash_{<} \mathbf{v}]
= 
&(t_1 \otimes t_3) \otimes \mathbb{1}_K \otimes (\mathbb{1_k}\ominus\delta(t_2)) 
\;\oplus\;\\ 
&(t_2 \otimes t_3) \otimes 0_K \otimes (\mathbb{1}_K\ominus\delta(t_1)) 
\;\oplus\;\\
&(t_1 \otimes t_2 \otimes t_3) \otimes 0_K \otimes (\mathbb{1}_K\ominus\delta(\emptyset))
\end{align*}


Let $\mathcal{X} = \{x_1, x_2, \dots, x_n\}$, be the variables, $w: \mathcal{X} \mapsto K$ be a valuation and,
$\mathcal{W} = \{w \mid w:\mathcal{X} \mapsto K\}$, be the set of all valuations.

For comparing two aggregations $\mathbf{u},\mathbf{v}$ we consider a possible-world setup where K is a Boolean semiring and valuations(here, possible worlds)
$w: \{1,2,\dots,m\} \mapsto \{0,1\}$ and $w': \{1,2,\dots,n\} \mapsto \{0,1\}$ such that, 

\begin{align*}
  &[[\mathbf{u} \oslash \mathbf{v}]]_{op}=\\
  &\bigoplus_{w,w'}\left(\bigotimes_{w(i)=1}u_i\otimes\bigotimes_{w'(j) = 1}v_j\otimes\left(1\ominus(\bigoplus_{w(i) =0}u_i\oplus \bigoplus_{w'(j) = 0}v_j)\right)\right)
\end{align*}


\subsubsection{Counting Semiring}
$$K = (\mathbb{N}, \oplus, \otimes, 0, 1)$$
$\mathbb{N} = \{0,1,2,\dots\}$

$\oplus : \text{Standard integer addition}$

$\otimes : \text{Standard integer multiplication}$

$\text{Zero} : 0 \in \mathbb{N}$

$\text{One} : 1 \in \mathbb{N}$

Additional operators:

Monus: $(a \ominus b): \text{Truncated subtraction}$
$$ a \ominus b = \begin{cases} 0, &  a\leq b\\ a-b,& a>b \end{cases}$$

Delta: 
For $a \in K$
$\delta(a) = \begin{cases} 0, & a=0\\ 1, & a>0 \end{cases}$
$\delta:K \mapsto K $
$\delta(0_K)=0_K$
$\delta(n.1_K)=1_K$


\textbf{Counting semiring properties:}

1. Additive monoid
- Associativity: $$(a \oplus b) \oplus c = a \oplus (b\oplus c)$$
- Commutativity: $$a \oplus b = b \oplus a$$
- Identity: $$a \oplus 0 = 0$$
2. Multiplicative monoid
- Associativity: $$( (a \otimes b) \otimes c = a \otimes (b\otimes c)$$
- Commutativity: $$a \otimes b = b \otimes a$$
- Identity: $$a \otimes 1 = a$$
3. Distributivity
- Left Dist: $$a \otimes (b \oplus c)= (a \otimes b)\oplus(a \otimes c)$$
- RIght Dist: $$(a \oplus b)\otimes c=(a \otimes c)\oplus(b \otimes c)$$
 4. Absorption
$$a \otimes 0 = 0 \otimes a = 0$$

5. Monus \newline
For $$a, b \in K$$
- $$(a \ominus b) \oplus b =a$$, if $$a \geq b$$
- $$a \ominus 0 =a$$
- $$0 \ominus a = 0$$

6. Semimodule operation
- Associative with semiring multiplication: $$a \otimes (b * m)= (a \otimes b) * m$$
- Identity: $$1*m=m$$
- Absorption: $$0*m=0$$
7. Other properties
$$
 \delta(u)\otimes[[u \oslash   v]]_{\mathit{op}}=\begin{cases}1, & \text{if } u\hspace{0.5em} op\hspace{0.5em} v \text{ holds in } \mathbb{N} \\
0,&\text{o.w.}\end{cases}
$$

e.g. For COUNT(*), say we have $f=\bigoplus_{g \in group}$ 1 and we want to filter on the aggregates HAVING >C

$$
 \delta(f)\otimes[[f \oslash   C]]_{\mathit{>}}=\begin{cases}1, & \text{if } f>C \text{ holds in } \mathbb{N} \\
0,&\text{o.w.}\end{cases}
$$

\subsubsection{Boolean Semiring}
$$B = (\{0,1\}, \lor, \land, 0, 1)$$
$$\lor : \text{Standard logical OR}$$
$$\land : \text{Standard logical AND}$$
$$0 : \text{Boolean zero}$$
$$1 : \text{Boolean one}$$
\[
\ominus: \text{Monus for Boolean Semiring} \quad a \ominus b := a \land \neg b
\]
Now we take a query as below on a relation $T$ with $n$ tuples:

\begin{listing}[ht]
\begin{minted}[linenos,frame=single,fontsize=\small]{sql}
SELECT DISTINCT 1
  FROM T
 HAVING COUNT(*) = c;
\end{minted}
\end{listing}

This returns 1 if the relation $T$ has exactly $c$ tuples, and 0 otherwise.

In possible world semantics, let $w: \{1,2,\dots,m\} \mapsto \{0,1\}$.

The provenance of this query can be expressed as follows:

$$q(T) = \bigoplus_{w}\left(\bigotimes_{w(i)=1}b_i\otimes\left(\mathbb{1}\ominus(\bigoplus_{w(i) =0}b_i)\right)\right)$$

On the other hand, its equivalent join query will be as follows:

\begin{listing}[ht]
\caption{Return 1 if \(|T| = c\) using joins on distinct rows}
\begin{minted}[linenos,frame=single,fontsize=\small]{sql}
SELECT DISTINCT 1
  FROM T AS a1
  JOIN T AS a2 ON a1.id <  a2.id
  JOIN T AS a3 ON a2.id <  a3.id
  -- ...
  JOIN T AS a_c ON a_{c-1}.id < a_c.id

EXCEPT

SELECT DISTINCT 1
  FROM T AS b1
  JOIN T AS b2 ON b1.id <  b2.id
  JOIN T AS b3 ON b2.id <  b3.id
  -- ...
  JOIN T AS b_{c+1} ON b_c.id < b_{c+1}.id;
\end{minted}
\end{listing}

The provenance of this query can be expressed as follows:
\[
q'(T) = \bigoplus_{\substack{t\subseteq T \\ |t| = c}}\left(\bigotimes_{\substack{b_i\in t}}b_i\right) \ominus \bigoplus_{\substack{t'\subseteq T \\ |t'| = c+1}}\left(\bigotimes_{\substack{b_i\in t'}}b_i\right)
\]

\begin{proof}
Define
\[
A \;=\; \bigvee_{\lvert t\rvert = c}\;\bigwedge_{i\in t} b_i,
\qquad
B \;=\; \bigvee_{\lvert t'\rvert = c+1}\;\bigwedge_{i\in t'} b_i.
\]
Since in the Boolean semiring \(\oplus=\vee\), \(\otimes=\wedge\) and
\(\;r\ominus s = r\wedge\neg s\), we have
\[
q'(T)
= A \ominus B
= A \wedge \neg B.
\]
Expand step by step:
\begin{align*}
q'(T)
&= \Bigl(\!\bigvee_{\lvert t\rvert = c}\!\bigwedge_{i\in t}b_i\Bigr)
   \;\wedge\;
   \neg\Bigl(\!\bigvee_{\lvert t'\rvert = c+1}\!\bigwedge_{i\in t'}b_i\Bigr)\\[6pt]
&= \Bigl(\!\bigvee_{\lvert t\rvert = c}\!\bigwedge_{i\in t}b_i\Bigr)
   \;\wedge\;
   \Bigl(\!\bigwedge_{\lvert t'\rvert = c+1}\!\neg\bigl(\!\bigwedge_{i\in t'}b_i\bigr)\Bigr)\\[6pt]
&= \bigvee_{\lvert t\rvert = c}
    \Bigl(
      \bigwedge_{i\in t}b_i
      \;\wedge\;
      \bigwedge_{|t'|=c+1}\!\neg\bigl(\!\bigwedge_{i\in t'}b_i\bigr)
    \Bigr).
\end{align*}

\textbf{Key simplification.}  Fix a particular \(t\) with \(\lvert t\rvert=c\).  Consider
\[
\bigwedge_{\substack{t'\subseteq[m]\\|t'|=c+1}}
\neg\Bigl(\!\bigwedge_{i\in t'}b_i\Bigr).
\]
- For each \(j\notin t\), the subset \(t'=t\cup\{j\}\) yields
  \(\neg\bigl(b_j\wedge\bigwedge_{i\in t}b_i\bigr)=\neg b_j\).  
- Any other \(t'\) also contains some \(j\notin t\), so its factor
  \(\neg(\bigwedge_{i\in t'}b_i)\) can be written as
  \(\neg b_j\vee Y\).  

with \(x=\neg b_j\), each such pair of factors collapses to \(\neg b_j\).  Hence the entire
AND reduces to
\(\bigwedge_{j\notin t}\neg b_j\).

Substituting back gives
\[
q'(T)
=\bigvee_{\lvert t\rvert = c}
\Bigl(\,\bigwedge_{i\in t}b_i
       \;\wedge\;
       \bigwedge_{j\notin t}\neg b_j
\Bigr)
=\;q(T),
\]
as required.
\end{proof}

\subsubsection{Semiring of Boolean Functions}

\(\varphi\colon \{\bot,\top\}^X \to \{\bot,\top\}\) is a Boolean-function annotation on tuples.
A valuation \(\nu\colon X \to \{\bot,\top\}\) denotes a possible world,
  indicating which tokens \(x\in X\) exist (\(\nu(x)=\top\)).
The semiring of Boolean functions is:
$$
B^X = (\{\varphi : \{ \bot,\top \}^X \to \{\bot,\top\}\},\vee,\wedge,0_B,1_B,\setminus_B)
$$
\begin{itemize}
    \item \(\varphi \vee \psi\): pointwise OR
    \item \(\varphi \wedge \psi\): pointwise AND
    \item \(0_B\): the constant-false function
    \item \(1_B\): the constant-true function
    \item Monus:
        $$
        \varphi \setminus_B \psi \;=\; \varphi \wedge \neg \psi
        $$
\end{itemize}

\input{homomorphisms.tex}

% Example citation to ensure at least one \cite command is present
As shown in~\cite{amsterdamer2011provenance}, provenance semirings...

\bibliographystyle{splncs04}
\bibliography{ref}
\end{document}
