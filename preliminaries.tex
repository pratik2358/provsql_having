\section{Preliminaries}

\pierre{3 pages}

\begin{itemize}
  \item Semirings, examples of Semirings
  \item Properties of semirings
  \item Table of semirings, with explanations
  \item Annotated relations, running example
  \item Queries, syntax and basics of semantics,
    linking to \cite{sen2026provsql} for the whole definitions
  \item Aggregate queries, arbitrary aggregate functions
\end{itemize}

\input{table_semirings}

We start by proving simple results that we would later need in the proof. We first show that in an $m$-semiring, additive idempotence is equivalent to $\ominus$ being right-distributive over $\oplus$.
\begin{proposition}
  \lean{SemiringWithMonus}{idempotent_iff_add_monus}
  Let $S$ be any m-semiring. $S$ is idempotent if and only if $\ominus$
  is right-distributive over~$\oplus$ in $S$.
\end{proposition}
\begin{proof}
  \textbf{($\Rightarrow$)}
  \lean{SemiringWithMonus}{add_monus_of_idempotent}
  Assume S to be additively idempotent. Define a preorder $\leq$ such that,
  if $a\leq b$ then $\exists x,\; a\oplus x=b$.
  So, $a \oplus b = a \oplus (a \oplus x)=(a\oplus a)\oplus x=a \oplus x = b$. \\$\therefore a\leq b \implies a\oplus b=b$.
  \\Conversely, if $a\oplus b = b$, choose $x=b$. And trivially, $a\oplus x =a\oplus b=b$
  $\implies a \leq b$.
  \\$\therefore a\leq b \iff a \oplus b =b$. Therefore, $(S,\leq)$ is indeed a partial order and $\oplus$ is monotone under $\leq$.
  \\Now, $\forall u, a \leq u$ and $b \leq u$
  \\ $a \oplus u = u$ and $b\oplus u =u$.
  \\But, $a\leq a \oplus b$ and $b \leq a \oplus b$
  \\$\therefore a \oplus b $ is the least such $u$ for which $a\leq u $ and $b \leq u$.
  So, $\oplus$ is the join of a semilattice of $(S,\leq)$.

  \paragraph{i.}
  By definition of monus : $x \ominus y \leq z \iff x \leq y \oplus z$,
  $a\leq a\oplus b\leq c \oplus ((a\oplus b)\ominus c) \implies a\ominus c\leq (a\oplus b)\ominus c$.
  Similarly, $b\ominus c\leq (a\oplus b)\ominus c$.
  \\$\therefore (a\ominus c)\oplus (b\ominus c) \leq (a\oplus b) \ominus c$
  \paragraph{ii.} We have $a\leq c \oplus (a\ominus c)$ and $b\leq c\oplus (b\ominus c)$. So, $a\oplus b \leq c\oplus c \oplus (a\ominus c) \oplus (b\ominus c)$.
  By idempotence of $\oplus$,  $a\oplus b \leq c \oplus (a\ominus c) \oplus (b\ominus c)$.
\\$\therefore $ $(a\oplus b) \ominus c \leq (a\ominus c)\oplus (b\ominus c) $, by definition of monus.
 \\ From \textbf{i.} \& \textbf{ii.}
  $$\boxed{(a\oplus b) \ominus c = (a\ominus c)\oplus (b\ominus c)}$$
\textbf{($\Leftarrow$)}
  \lean{SemiringWithMonus}{idempotent_of_add_monus}
Assume that $\ominus$ of S is right-distributive:
\[
  (a\oplus b)\ominus c
  = (a\ominus c)\oplus(b\ominus c)\;\forall a,b,c\in S.
\]

For any arbitrary $a\in S$ substitute $b=a$ and $c=a$:
\[
  (a\oplus a)\ominus a
  = (a\ominus a)\oplus(a\ominus a).
\]
Since $a\ominus a=0$, the right-hand side is $0$. And $(a\oplus a)\ominus a = 0\implies a\oplus a\leq a$ by definition of monus.
  But, trivially $a\le a\oplus a$, so antisymmetry of $(S,\leq)$ gives $a\oplus a=a$.
  Thus, $$\boxed{a \oplus a=a, \; \forall a\in S}$$
\smallskip
Both sides, prove the equivalence.
\end{proof}
% This is wrong but why?
%\begin{proposition}
%   Let $K_1, K_2$ be two m-semirings and $h: K_1\to K_2$ a semiring
%   homomorphism. Then $h$ is an m-semiring homomorphism.
% \end{proposition}
\begin{corollary}[Right-distributivity of $\ominus$ over finite $\oplus$-sums]\label{lem:finite-add-monus}
Let \((K,\oplus,\otimes,\mathbb{0},\mathbb{1},\delta,\ominus)\) be an
m-semiring in which \(\ominus\) is right-distributive over \(\oplus\), i.e.,
\[
(a \oplus b) \ominus c = (a \ominus c) \oplus (b \ominus c)
\quad\text{for all } a,b,c \in K.
\]
Then for every \(n \ge 1\) and all \(a_1,\dots,a_n,c \in K\),
\[
\Bigl(\bigoplus_{i=1}^n a_i\Bigr)\ominus c
=
\bigoplus_{i=1}^n (a_i \ominus c).
\]
\end{corollary}

\begin{proof}
We proceed by induction on \(n \ge 1\).

For \(n=1\), the identity is trivial.
For \(n=2\), the statement is exactly the assumed right-distributivity law:
\[
(a_1 \oplus a_2)\ominus c = (a_1\ominus c)\oplus(a_2\ominus c).
\]

Assume the identity holds for \(n-1\).
Then
\[
\begin{aligned}
\Bigl(\bigoplus_{i=1}^n a_i\Bigr)\ominus c
&= \Bigl(\bigl(\bigoplus_{i=1}^{n-1} a_i\bigr)\oplus a_n\Bigr)\ominus c \\
&= \Bigl(\bigoplus_{i=1}^{n-1} a_i\Bigr)\ominus c \;\oplus\; (a_n\ominus c) \\
&= \bigoplus_{i=1}^{n-1} (a_i\ominus c) \;\oplus\; (a_n\ominus c)
= \bigoplus_{i=1}^n (a_i\ominus c),
\end{aligned}
\]
where the second equality uses right-distributivity and the third uses the
induction hypothesis.
\end{proof}
We now isolate two elementary inequalities on the residual charecterization of $\ominus$ and the natural order defined for commutativ $m-$semirings.
\begin{proposition}
  Let $\mathbb{K}_1, \mathbb{K}_2$ be two m-semirings and $h:
  \mathbb{K}_1\to \mathbb{K}_2$ a m-semiring
  homomorphism. Then:
    \begin{enumerate}[(i)]
    \item
      \lean{SemiringWithMonus}{idempotent_of_injective_homomorphism_idempotent}
      If $h$ is injective and $\mathbb{K}_2$ idempotent, then so is
      $\mathbb{K}_1$.
      \item
        \lean{SemiringWithMonus}{idempotent_of_surjective_homomorphism_idempotent}
      If $h$ is surjective and $\mathbb K_1$ idempotent, then so is
      $\mathbb K_2$.
      \item
        \lean{SemiringWithMonus}{mul_sub_left_of_injective_homomorphism_mul_sub_left}
        If $h$ is injective and $\otimes$ is left-distributive over $\ominus$ in $\mathbb{K}_2$, the
        is true in~$\mathbb{K}_1$.
        \item
        \lean{SemiringWithMonus}{mul_sub_left_of_surjective_homomorphism_mul_sub_left}
        If $h$ is surjective and $\otimes$ is left-distributive over $\ominus$ in $\mathbb{K}_1$, the
        is true in~$\mathbb{K}_2$.
    \end{enumerate}
\end{proposition}

\begin{lemma}\label{lem:x-y<=x}
  \pierre{We should directly refer to the definition of an m-semiring.}
Let $(K,\oplus,\mathbb 0)$ be an idempotent commutative monoid, equipped with an
operation $\ominus$ satisfying the residuation law: for all $x,y,z\in K$,
\begin{equation}\label{eq:residuation-monus}
  x\ominus y \le z \quad\Longleftrightarrow\quad x \le y\oplus z,
\end{equation}
where $\le$ is the natural order $a\le b \iff a\oplus b=b$.
Then for all $x,y\in K$,
\[
  x\ominus y \le x.
\]
\end{lemma}

\begin{proof}
By \eqref{eq:residuation-monus} with $z=x$, we have
\[
x\ominus y \le x \quad\Longleftrightarrow\quad x \le y\oplus x.
\]
But $x\le y\oplus x$ holds because $x\oplus(y\oplus x)=(x\oplus x)\oplus y=x\oplus y=y\oplus x$
(using associativity, commutativity and idempotence of $\oplus$).
Hence $x\ominus y\le x$.
\end{proof}

  \begin{lemma}\label{lem:x<=y+(x-y)}
    \pierre{Same.}
  Under the assumptions of Lemma~\ref{lem:x-y<=x}, for all $x,y\in K$,
\[
  x \le y\oplus (x\ominus y).
\]
\end{lemma}

\begin{proof}
Apply \eqref{eq:residuation-monus} with $z=x\ominus y$:
since $x\ominus y\le x\ominus y$ holds trivially, \eqref{eq:residuation-monus} yields
\[
x \le y\oplus (x\ominus y),
\]
as required.
\end{proof}
Next, we state a bounding lemma that we later use in the proof to show that summing $T_U(W)$ over all $W\supseteq V$ always dominates the product $A_V$ for $V\subseteq U$.
\begin{lemma}\label{lem:upward-expansion}
Let $(K,\oplus,\otimes,\mathbb 0,\mathbb 1,\ominus)$ be an idempotent $m$-semiring,
and write the natural order as $a\le b \iff a\oplus b=b$.
Assume that $\ominus$ is the (right) residual of $\oplus$, i.e.\ for all $x,y,z\in K$,
\begin{equation}\label{eq:residuation}
  x\ominus y \le z \quad\Longleftrightarrow\quad x \le y\oplus z .
\end{equation}
  Fix a finite set $U$ and elements $(\alpha)_{x\in U}\in K$.
For $W\subseteq U$ define
\[
  A_W := \bigotimes_{x\in W}\alpha_x ,
  \qquad
  T_U(W) := A_W \ominus \bigoplus_{x\in U\setminus W} A_{W\cup\{x\}} .
\]
Then for every $V\subseteq U$,
\begin{equation}\label{eq:upward-expansion}
  A_V \;\le\; \bigoplus_{\substack{W:\;V\subseteq W\subseteq U}} T_U(W).
\end{equation}
\end{lemma}

\begin{proof}
We prove \eqref{eq:upward-expansion} by induction on $d:=|U\setminus V|$.

\smallskip\noindent
\textbf{Base case ($d=0$).}
Then $V=U$. Since $U\setminus U=\varnothing$ and $\bigoplus_{\varnothing}(\cdot)=\mathbb 0$,
\[
  T_U(U)=A_U\ominus \mathbb 0.
\]
We claim $A_U\ominus\mathbb 0=A_U$. Indeed, by \eqref{eq:residuation}, for any $z\in K$,
\[
  A_U\ominus\mathbb 0 \le z \iff A_U \le \mathbb 0\oplus z = z,
\]
so $A_U\ominus\mathbb 0$ is the greatest element below $A_U$, hence equals $A_U$.
Therefore,
\[
  \bigoplus_{\substack{W:\;U\subseteq W\subseteq U}} T_U(W)=T_U(U)=A_U=A_V,
\]
and \eqref{eq:upward-expansion} holds.

\smallskip\noindent
\textbf{Inductive step.}
Assume $d>0$ and that \eqref{eq:upward-expansion} holds for all pairs $(U,V')$
with $V\subsetneq V'\subseteq U$ and $|U\setminus V'|<d$.
Let
\[
  Y := \bigoplus_{x\in U\setminus V} A_{V\cup\{x\}} \in K.
\]
From Lemma~\ref{lem:x<=y+(x-y)} we obtain the standard inequality
\begin{equation}\label{eq:M2-lemma1}
  X \le Y \oplus (X\ominus Y)\qquad\text{for all }X,Y\in K,
\end{equation}
by instantiating \eqref{eq:residuation} with $z=X\ominus Y$ (since $X\ominus Y\le X\ominus Y$).
Applying \eqref{eq:M2-lemma1} to $X=A_V$ gives
\[
  A_V \le Y \oplus (A_V\ominus Y).
\]
By definition of $T_U(V)$ we have $A_V\ominus Y = T_U(V)$, hence
\begin{equation}\label{eq:AV-bound}
  A_V \le T_U(V)\ \oplus\ \bigoplus_{x\in U\setminus V} A_{V\cup\{x\}}.
\end{equation}

For each $x\in U\setminus V$ set $V_x:=V\cup\{x\}$. Then $|U\setminus V_x|=d-1$,
so the induction hypothesis yields
\[
  A_{V_x}\le \bigoplus_{\substack{W:\;V_x\subseteq W\subseteq U}} T_U(W).
\]
Taking the $\oplus$-sum over all $x\in U\setminus V$ and using monotonicity of $\oplus$,
\[
  \bigoplus_{x\in U\setminus V} A_{V\cup\{x\}}
  =
  \bigoplus_{x\in U\setminus V} A_{V_x}
  \le
  \bigoplus_{x\in U\setminus V}\ \bigoplus_{\substack{W:\;V_x\subseteq W\subseteq U}} T_U(W).
\]
Every $W$ appearing on the right satisfies $V\subseteq V_x\subseteq W\subseteq U$, hence $V\subseteq W\subseteq U$.
Therefore, using associativity/commutativity/idempotence of $\oplus$ to ignore duplicates and reorder summands,
\[
  \bigoplus_{x\in U\setminus V}\ \bigoplus_{\substack{W:\;V_x\subseteq W\subseteq U}} T_U(W)
  \le
  \bigoplus_{\substack{W:\;V\subseteq W\subseteq U}} T_U(W).
\]
Combining with \eqref{eq:AV-bound} yields
\[
  A_V \le T_U(V)\ \oplus\ \bigoplus_{\substack{W:\;V\subseteq W\subseteq U}} T_U(W)
  =
  \bigoplus_{\substack{W:\;V\subseteq W\subseteq U}} T_U(W),
\]
since the right-hand $\oplus$-sum already includes the summand $T_U(V)$ (take $W=V$).
This proves \eqref{eq:upward-expansion} for $V$ and completes the induction.
\end{proof}
